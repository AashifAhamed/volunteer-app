name: Deploy to cPanel via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, bcmath, pdo, pdo_mysql
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Composer Dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs
          
      - name: Install NPM Dependencies
        run: |
          npm ci
          
      - name: Build Assets
        run: |
          npm run build
          
      - name: Create deployment package
        run: |
          # Create a temporary directory for deployment
          mkdir -p deploy_temp
          
          # Copy all files except excluded ones
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.phpunit.cache' \
            --exclude='.phpunit.result.cache' \
            --exclude='Homestead.json' \
            --exclude='Homestead.yaml' \
            --exclude='auth.json' \
            --exclude='npm-debug.log' \
            --exclude='yarn-error.log' \
            --exclude='.fleet' \
            --exclude='.idea' \
            --exclude='.vscode' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='tests' \
            --exclude='phpunit.xml' \
            --exclude='README.md' \
            --exclude='postcss.config.js' \
            --exclude='tailwind.config.js' \
            --exclude='vite.config.js' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            ./ deploy_temp/
          
      - name: Deploy to FTP using lftp
        run: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -c "
            set ftp:passive-mode true;
            set ftp:use-feat false;
            set ftp:ssl-allow no;
            set net:timeout 60;
            set net:max-retries 5;
            set net:reconnect-interval-base 10;
            set net:reconnect-interval-multiplier 1;
            open -p ${{ secrets.FTP_PORT || '21' }} -u '${{ secrets.FTP_USER }}','${{ secrets.FTP_PASSWORD }}' ${{ secrets.FTP_HOST }};
            cd ${{ secrets.FTP_REMOTE_DIR }};
            mirror --reverse --delete --verbose --exclude-glob='.git*' --exclude-glob='node_modules/**' --exclude-glob='.env*' --exclude-glob='tests/**' --exclude-glob='phpunit.xml' --exclude-glob='README.md' --exclude-glob='.github/**' --exclude-glob='deploy_temp/**' ./deploy_temp/ .;
            quit;
          "
            
      - name: Cleanup
        if: always()
        run: |
          rm -rf deploy_temp

