name: Deploy to cPanel via FTP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, bcmath, pdo, pdo_mysql
          coverage: none
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs
          
      - name: Install NPM dependencies
        run: |
          npm ci
          
      - name: Build assets
        run: |
          npm run build
          
      - name: Create deployment package
        run: |
          # Create a clean deployment directory
          mkdir -p deployment
          
          # Copy application files (excluding development files)
          rsync -av --exclude='.git*' \
                    --exclude='node_modules' \
                    --exclude='tests' \
                    --exclude='.github' \
                    --exclude='storage/logs/*' \
                    --exclude='storage/framework/cache/*' \
                    --exclude='storage/framework/sessions/*' \
                    --exclude='storage/framework/views/*' \
                    --exclude='storage/app/public/*' \
                    --exclude='.env.example' \
                    --exclude='composer.lock' \
                    --exclude='package-lock.json' \
                    --exclude='phpunit.xml' \
                    --exclude='README.md' \
                    --exclude='.editorconfig' \
                    --exclude='.gitattributes' \
                    --exclude='.gitignore' \
                    --exclude='postcss.config.js' \
                    --exclude='tailwind.config.js' \
                    --exclude='vite.config.js' \
                    ./ deployment/
          
          # Create necessary directories
          mkdir -p deployment/storage/logs
          mkdir -p deployment/storage/framework/cache
          mkdir -p deployment/storage/framework/sessions
          mkdir -p deployment/storage/framework/views
          mkdir -p deployment/storage/app/public
          
          # Set proper permissions (for local, actual permissions set on server)
          chmod -R 755 deployment/
          chmod -R 775 deployment/storage/
          chmod -R 775 deployment/bootstrap/cache/
          
          # Create deployment info file
          echo "Deployed at: $(date)" > deployment/DEPLOYMENT_INFO.txt
          echo "Commit: ${{ github.sha }}" >> deployment/DEPLOYMENT_INFO.txt
          echo "Branch: ${{ github.ref_name }}" >> deployment/DEPLOYMENT_INFO.txt
          
      - name: Deploy to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deployment/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/.github/**
            **/storage/logs/*
            **/storage/framework/cache/*
            **/storage/framework/sessions/*
            **/storage/framework/views/*
            **/storage/app/public/*
            **/.env.example
            **/composer.lock
            **/package-lock.json
            **/phpunit.xml
            **/README.md
            **/.editorconfig
            **/.gitattributes
            **/.gitignore
            **/postcss.config.js
            **/tailwind.config.js
            **/vite.config.js
          dangerous-clean-slate: false
          
      - name: Post-deployment cleanup
        if: always()
        run: |
          rm -rf deployment/
          
      - name: Deployment notification
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
